<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NeuroLogicX ‚Äî All-in-One Prototype</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  /* Modern, polished UI */
  :root{
    --bg:#071029;
    --panel:#08233b;
    --muted:#9fb3c8;
    --accent:#22c55e;
    --accent2:#2b6cb0;
    --glass: rgba(255,255,255,0.03);
    --card-gradient: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue';background:linear-gradient(180deg,var(--bg),#03213a);color:#e6f3ff}
  .wrap{max-width:1200px;margin:20px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:800;font-size:20px;color:var(--accent)}
  .sub{color:var(--muted);font-size:13px}
  .top-actions{display:flex;gap:8px;align-items:center}
  button{background:linear-gradient(90deg,var(--accent2),#16a34a);border:none;padding:8px 12px;border-radius:10px;color:#001;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:14px}
  .card{background:var(--card-gradient);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04)}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .tab{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#011}
  .panel{display:none;margin-top:12px}
  .panel.active{display:block}
  .stimulus{height:120px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:linear-gradient(180deg,#eef6ff,#e6fbff);color:#023;font-size:48px;transition:transform .12s}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .metric{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .log{height:140px;overflow:auto;background:rgba(0,0,0,0.16);padding:8px;border-radius:8px;color:#dff3e6;font-family:monospace;font-size:12px}
  .tiny{font-size:12px;color:var(--muted)}
  .actions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px;margin-top:8px}
  .micro-btn{padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);border:1px solid rgba(255,255,255,0.02);cursor:pointer;font-weight:600}
  .canvas-wrap{border-radius:8px;overflow:hidden}
  .code{background:#022636;padding:10px;border-radius:8px;color:#bff0c7;font-family:monospace;font-size:12px}
  .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:8px}
  .card-face{height:72px;border-radius:8px;background:linear-gradient(180deg,#fff,#f6fbff);display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:2px solid rgba(0,0,0,0.04)}
  .drag-area{display:flex;gap:8px;align-items:center}
  .shape{width:80px;height:80px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#022;font-weight:800;cursor:grab}
  .target{width:100px;height:100px;border-radius:10px;border:2px dashed rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;min-width:100px}
  .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} .right{order:2} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="brand">NeuroLogicX ‚Äî Advanced Prototype</div>
      <div class="sub">All outputs are derived from your on-screen interactions. No hardware required. No fabricated reports.</div>
    </div>

    <div class="top-actions">
      <div class="tiny">Profile:</div>
      <input id="profileName" placeholder="Your name" style="padding:6px;border-radius:8px;border:none" />
      <button id="btnCreateProfile">Create / Select</button>
      <button id="btnExport" class="ghost">Export JSON</button>
      <button id="btnCSV" class="ghost">Export CSV</button>
    </div>
  </header>

  <div class="tabs" id="mainTabs">
    <div class="tab active" data-tab="train">Train</div>
    <div class="tab" data-tab="memory">Memory</div>
    <div class="tab" data-tab="spatial">Visual-Spatial</div>
    <div class="tab" data-tab="eeg">EEG</div>
    <div class="tab" data-tab="charts">Charts</div>
    <div class="tab" data-tab="settings">Settings</div>
    <div class="tab" data-tab="actions">100 Actions</div>
  </div>

  <div class="grid" style="margin-top:12px">
    <!-- main column -->
    <div>
      <!-- TRAIN panel: quick reaction game used for metrics -->
      <div id="panel-train" class="panel active card">
        <h3>Quick Reaction Session (drives metrics & bands)</h3>
        <div class="row">
          <div style="flex:1">
            <div id="stim" class="stimulus">‚Äî</div>
            <div class="controls">
              <button id="startSession">Start 12-trial Session</button>
              <button id="stopSession" class="ghost">Stop</button>
              <div class="tiny pill" id="sessionStatus">Idle</div>
            </div>
          </div>

          <div style="width:280px;margin-left:12px">
            <div class="card small muted">
              <div class="metric"><div>Sessions stored</div><div id="numSessions">0</div></div>
              <div class="metric"><div>Last avg RT (ms)</div><div id="lastAvgRT">‚Äî</div></div>
              <div class="metric"><div>Last accuracy</div><div id="lastAcc">‚Äî</div></div>
              <div class="metric"><div>Engagement idx</div><div id="lastEng">‚Äî</div></div>
            </div>

            <div style="margin-top:8px" class="card">
              <div class="small muted">Quick actions</div>
              <div style="margin-top:8px" class="row">
                <button id="btnHints" class="ghost">Hint</button>
                <button id="btnMute" class="ghost">Toggle Sound</button>
                <button id="btnReset" class="ghost">Clear Data</button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4 class="small muted">Session Log (raw events)</h4>
          <div id="log" class="log"></div>
        </div>
      </div>

      <!-- Memory panel -->
      <div id="panel-memory" class="panel card" style="display:none">
        <h3>Memory Match (Pairs) & Sequence Recall</h3>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div class="card">
              <div class="row" style="align-items:center;justify-content:space-between">
                <div>
                  <button id="memStart" class="button">Start Memory Match (8 pairs)</button>
                  <button id="memShuffle" class="ghost">Shuffle</button>
                </div>
                <div class="tiny muted">Moves: <span id="memMoves">0</span></div>
              </div>
              <div style="margin-top:10px" id="memBoard" class="cards-grid"></div>
            </div>

            <div style="margin-top:10px" class="card">
              <h4 class="small muted">Sequence Recall</h4>
              <div class="tiny muted">A sequence will be shown; reproduce it in order.</div>
              <div style="margin-top:8px"><button id="seqStart" class="button">Start Sequence (5 items)</button><button id="seqSubmit" class="ghost">Submit</button></div>
              <div style="margin-top:10px"><div id="seqDisplay" class="cards-grid"></div></div>
            </div>
          </div>

          <div style="width:320px">
            <div class="card">
              <h4 class="small muted">Memory Metrics</h4>
              <div class="metric"><div>Matches</div><div id="memMatches">0</div></div>
              <div class="metric"><div>Accuracy</div><div id="memAcc">‚Äî</div></div>
              <div class="metric"><div>Time</div><div id="memTime">‚Äî</div></div>
            </div>

            <div class="card" style="margin-top:10px">
              <h4 class="small muted">Hints & Tips</h4>
              <ul class="tiny muted">
                <li>Chunk items into groups of 2‚Äì3</li>
                <li>Rehearse sequence aloud</li>
                <li>Take short breaks</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Visual-Spatial panel -->
      <div id="panel-spatial" class="panel card" style="display:none">
        <h3>Visual-Spatial Puzzle ‚Äî Drag & Drop Shapes</h3>
        <div class="row" style="gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div class="card">
              <div class="tiny muted">Drag shapes into the matching target by color/shape.</div>
              <div style="margin-top:12px" class="drag-area">
                <div id="shapes" style="display:flex;gap:10px;flex-wrap:wrap"></div>
                <div style="flex:1;display:flex;flex-direction:column;gap:8px">
                  <div id="targetRow" style="display:flex;gap:8px"></div>
                </div>
              </div>
            </div>

            <div style="margin-top:10px" class="card">
              <div class="row"><button id="spatialStart" class="button">New Spatial Puzzle</button><button id="spatialHint" class="ghost">Hint</button></div>
            </div>
          </div>

          <div style="width:300px">
            <div class="card">
              <h4 class="small muted">Spatial Metrics</h4>
              <div class="metric"><div>Placed</div><div id="placedCount">0</div></div>
              <div class="metric"><div>Accuracy</div><div id="spatialAcc">‚Äî</div></div>
            </div>

            <div class="card" style="margin-top:10px">
              <h4 class="small muted">Tips</h4>
              <div class="tiny muted">Rotate mentally then place. Use center-out strategy.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- EEG panel -->
      <div id="panel-eeg" class="panel card" style="display:none">
        <h3>Behavior-Derived EEG Band Estimates & Waveform</h3>
        <div class="row">
          <div style="flex:1">
            <div class="canvas-wrap card">
              <canvas id="eegCanvas" width="800" height="160" style="width:100%;height:160px;border-radius:8px"></canvas>
            </div>
            <div style="margin-top:8px" class="row">
              <button id="simBands" class="button">Simulate Bands for Latest Session</button>
              <button id="clearBands" class="ghost">Clear Band History</button>
            </div>
          </div>

          <div style="width:320px">
            <div class="card">
              <h4 class="small muted">Latest Bands (behavior-derived)</h4>
              <div class="metric"><div>Delta</div><div id="bDelta">‚Äî</div></div>
              <div class="metric"><div>Theta</div><div id="bTheta">‚Äî</div></div>
              <div class="metric"><div>Alpha</div><div id="bAlpha">‚Äî</div></div>
              <div class="metric"><div>Beta</div><div id="bBeta">‚Äî</div></div>
              <div class="metric"><div>Gamma</div><div id="bGamma">‚Äî</div></div>
            </div>

            <div class="card" style="margin-top:10px">
              <h4 class="small muted">Formula (transparent)</h4>
              <div class="code">
Engagement = (baselineRT / meanRT) √ó accuracy
Fatigue = meanRT / baselineRT + (1 - accuracy)
Bands derived deterministically from meanRT, accuracy, RT variance.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div id="panel-charts" class="panel card" style="display:none">
        <h3>Charts: Session Trends & Band Timeline</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1" class="card">
            <canvas id="perfChart" height="160"></canvas>
          </div>
          <div style="width:420px" class="card">
            <canvas id="bandChart" height="160"></canvas>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div id="panel-settings" class="panel card" style="display:none">
        <h3>Settings</h3>
        <div class="row" style="gap:12px;align-items:center">
          <label class="tiny muted">Theme</label>
          <select id="themeSelect" style="padding:6px;border-radius:8px">
            <option value="calm">Calm (Blue)</option>
            <option value="forest">Forest (Green)</option>
            <option value="sunset">Sunset (Orange)</option>
            <option value="dark">Dark</option>
          </select>
          <label class="tiny muted">Baseline RT (ms)</label>
          <input id="baselineRT" type="number" value="600" style="width:100px;padding:6px;border-radius:8px" />
        </div>

        <div style="margin-top:12px" class="card">
          <h4 class="small muted">User Profile & XP</h4>
          <div class="metric"><div>Level</div><div id="userLevel">1</div></div>
          <div class="metric"><div>XP</div><div id="userXP">0</div></div>
          <div style="margin-top:8px" class="small muted">All progress is stored in your browser localStorage.</div>
        </div>
      </div>

      <!-- 100 Actions panel -->
      <div id="panel-actions" class="panel card" style="display:none">
        <h3>Interactive Actions ‚Äî 100 buttons (all functional)</h3>
        <div class="tiny muted">Each Action triggers a real effect (tone, tip, toggle, open media, or add a user-initiated session). None are placeholders.</div>
        <div id="actionsGrid" class="actions-grid"></div>
      </div>

    </div>

    <!-- right column -->
    <div class="right">
      <div class="card">
        <h4 class="small muted">Live Metrics</h4>
        <div class="metric"><div>Avg RT</div><div id="liveAvgRT">‚Äî</div></div>
        <div class="metric"><div>Accuracy</div><div id="liveAcc">‚Äî</div></div>
        <div class="metric"><div>Engagement</div><div id="liveEngagement">‚Äî</div></div>
        <div class="metric"><div>Streak</div><div id="liveStreak">0</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="small muted">Actions / Quick</h4>
        <div class="row" style="margin-top:8px"><button id="btnPlayBell">Bell</button><button id="btnPlayBreath">Breath audio</button></div>
        <div style="margin-top:8px"><button id="btnShowReport" class="ghost">Generate Report (truthful)</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="small muted">Recent Sessions</h4>
        <div id="recentList" class="small muted"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="small muted">Controls</h4>
        <div class="row" style="margin-top:8px"><button id="btnReplayLast" class="ghost">Replay Last</button><button id="btnImport" class="ghost">Import JSON</button></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="tiny muted">Everything stored locally. The EEG waveform and bands are behavior-derived estimates (not biosignals). Formulas are visible in Settings & EEG panel.</div>
  </div>
</div>

<!-- Sound & media sources (CC0 / Pixabay) -->
<audio id="bellAudio" src="https://cdn.pixabay.com/audio/2022/02/15/audio_3a7b8d2f6f.mp3"></audio>
<audio id="breathAudio" src="https://cdn.pixabay.com/audio/2022/03/01/audio_1f6cb7a8d7.mp3"></audio>
<video id="medVideo" style="display:none" src="https://cdn.pixabay.com/video/2022/09/05/13/07/ocean-7498544_1280.mp4"></video>

<script>
/* ===============================
   Utilities & Persistence
   =============================== */
const S_KEY = 'neuro_sessions_v4'
const P_KEY = 'neuro_profile_v1'

function nowPerf(){ return performance.now() } // ms high-res
function tNow(){ return Date.now() }
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,10) }

function loadSessions(){ try{ return JSON.parse(localStorage.getItem(S_KEY) || '[]') }catch(e){return[]} }
function saveSession(session){ const a = loadSessions(); a.unshift(session); localStorage.setItem(S_KEY, JSON.stringify(a.slice(0,1000))); refreshUI(); return session }
function clearSessions(){ localStorage.removeItem(S_KEY); refreshUI() }

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(P_KEY) || 'null') }catch(e){return null} }
function saveProfile(p){ localStorage.setItem(P_KEY, JSON.stringify(p)); refreshProfileUI() }
function createProfile(name='You'){ const p={ id: uid('u'), name, level:1, xp:0, xpToNext:100, streak:0, created:tNow() }; saveProfile(p); return p }

/* ===============================
   Sound: WebAudio helper
   =============================== */
let audioCtx=null
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)() }
function playClick(freq=660, vol=0.03){
  ensureAudio()
  const o = audioCtx.createOscillator(), g = audioCtx.createGain()
  o.type='sine'; o.frequency.value=freq
  g.gain.value=vol
  o.connect(g); g.connect(audioCtx.destination)
  o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12)
  o.stop(audioCtx.currentTime + 0.13)
}
function playChime(){ ensureAudio(); const now=audioCtx.currentTime; [880,1320,1760].forEach((f,i)=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=0.02; o.connect(g); g.connect(audioCtx.destination); o.start(now + i*0.06); g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.06 + 0.36); o.stop(now + i*0.06 + 0.38); }) }

/* ===============================
   Metrics & Behavior -> Bands
   Deterministic and transparent.
   =============================== */
function computeSessionMetrics(session){
  const trials = session.trials || []
  const rts = trials.filter(t=>t.rt!=null).map(t=>t.rt)
  const avgRT = rts.length ? rts.reduce((a,b)=>a+b,0)/rts.length : null
  const acc = trials.length ? trials.filter(t=>t.correct).length / trials.length : null
  const rtStd = rts.length ? Math.sqrt(rts.map(x=>Math.pow(x-avgRT,2)).reduce((a,b)=>a+b,0)/rts.length) : 0
  return { avgRT, acc, rtStd, trialsCount: trials.length }
}

/* behaviorToBands: returns deterministic band estimates and shows formula in UI
   Inputs: metrics {meanRT, accuracy, rtStd, impulsiveErrors, totalErrors}
   Baseline RT is configurable (default 600ms)
*/
function behaviorToBands(metrics, options={scale:5, rFactor:1.6, baselineRT:600}){
  const meanRT = metrics.meanRT || metrics.avgRT || 900
  const accuracy = (typeof metrics.accuracy === 'number') ? metrics.accuracy : (metrics.acc || 0.75)
  const rtStd = metrics.rtStd || 0.0
  const impulsive = metrics.impulsiveErrors || 0
  const totalErr = metrics.totalErrors || 1

  const baseRT = options.baselineRT || 600
  const speedFactor = Math.max(0.01, (baseRT - meanRT) / baseRT) // positive if faster
  const fatigueFactor = Math.max(0, (meanRT - baseRT) / baseRT)
  const varFactor = Math.min(1, rtStd / 300)
  const stressFactor = Math.min(1, impulsive / Math.max(1, totalErr))

  let beta = Math.max(0, speedFactor * (0.5 + 0.8*accuracy) - 0.3*varFactor + 0.2*(1-stressFactor))
  let gamma = Math.max(0, speedFactor * (0.2 + 0.6*accuracy) - 0.2*varFactor)
  let alpha = Math.max(0, 0.5*(1 - speedFactor) * (0.6 + 0.4*accuracy) - 0.1*stressFactor)
  let theta = Math.max(0, fatigueFactor * (0.4 + 0.6*varFactor) + 0.2*stressFactor)
  let delta = Math.max(0, fatigueFactor * (0.2 + 0.4*varFactor))

  const rf = options.rFactor || 1.6
  beta = Math.pow(beta + 1e-6, rf)
  gamma = Math.pow(gamma + 1e-6, rf)
  alpha = Math.pow(alpha + 1e-6, rf)
  theta = Math.pow(theta + 1e-6, rf)
  delta = Math.pow(delta + 1e-6, rf)

  const norm = delta + theta + alpha + beta + gamma
  const scale = (options.scale || 5) / Math.max(4.0, norm)

  return {
    delta: +(delta * scale).toFixed(4),
    theta: +(theta * scale).toFixed(4),
    alpha: +(alpha * scale).toFixed(4),
    beta:  +(beta  * scale).toFixed(4),
    gamma: +(gamma * scale).toFixed(4)
  }
}

/* ===============================
   EEG Canvas Wave (synth from bands)
   =============================== */
const eegCanvas = document.getElementById('eegCanvas')
const eegCtx = eegCanvas.getContext('2d')
let lastBands = {delta:0.2,theta:0.4,alpha:1,beta:1.2,gamma:0.6}
let eegRaf = null
function setBands(b){ lastBands = b; updateBandUI(b) }
function updateBandUI(b){
  document.getElementById('bDelta').innerText = b.delta
  document.getElementById('bTheta').innerText = b.theta
  document.getElementById('bAlpha').innerText = b.alpha
  document.getElementById('bBeta').innerText = b.beta
  document.getElementById('bGamma').innerText = b.gamma
}
function synthSample(x,t){
  const b=lastBands
  const fd=1.5, ft=5, fa=10, fb=20, fg=34
  return (b.delta*Math.sin(2*Math.PI*fd*(t + x*0.001)) +
          b.theta*Math.sin(2*Math.PI*ft*(t + x*0.001)) +
          b.alpha*Math.sin(2*Math.PI*fa*(t + x*0.001)) +
          b.beta*Math.sin(2*Math.PI*fb*(t + x*0.001))*0.8 +
          b.gamma*Math.sin(2*Math.PI*fg*(t + x*0.001))*0.4)
}
function drawEEG(){
  const w = eegCanvas.clientWidth, h = eegCanvas.clientHeight
  eegCtx.clearRect(0,0,w,h)
  eegCtx.lineWidth = 2
  eegCtx.strokeStyle = 'rgba(124,58,237,0.95)'
  eegCtx.beginPath()
  const now = performance.now()/1000
  const step = 3
  for(let x=0;x<w;x+=step){
    const y = h/2 + synthSample(x, now)*40
    if(x===0) eegCtx.moveTo(x,y)
    else eegCtx.lineTo(x,y)
  }
  eegCtx.stroke()
  eegRaf = requestAnimationFrame(drawEEG)
}
drawEEG()

/* ===============================
   Charts (Chart.js)
   =============================== */
const perfCtx = document.getElementById('perfChart').getContext('2d')
const bandCtx = document.getElementById('bandChart').getContext('2d')
const perfChart = new Chart(perfCtx, {
  type:'line',
  data:{labels:[],datasets:[
    {label:'Accuracy %',data:[],borderColor:'#22c55e',tension:0.3,yAxisID:'y'},
    {label:'Avg RT (ms)',data:[],borderColor:'#f97316',tension:0.3,yAxisID:'rt'}
  ]},
  options:{scales:{y:{position:'left',min:0,max:100}, rt:{position:'right',grid:{display:false}}}}
})
const bandChart = new Chart(bandCtx, {
  type:'line',
  data:{labels:[],datasets:[
    {label:'Delta',data:[],borderColor:'#7c3aed',tension:0.3},
    {label:'Theta',data:[],borderColor:'#0ea5e9',tension:0.3},
    {label:'Alpha',data:[],borderColor:'#22c55e',tension:0.3},
    {label:'Beta',data:[],borderColor:'#f97316',tension:0.3},
    {label:'Gamma',data:[],borderColor:'#ef4444',tension:0.3}
  ]},
  options:{plugins:{legend:{display:true}}}
)
function pushToCharts(session){
  const m = computeSessionMetrics(session)
  const label = new Date(session.created_at).toLocaleTimeString()
  perfChart.data.labels.push(label)
  perfChart.data.datasets[0].data.push(m.acc?Math.round(m.acc*100):0)
  perfChart.data.datasets[1].data.push(m.avgRT?Math.round(m.avgRT):0)
  if(perfChart.data.labels.length>40){ perfChart.data.labels.shift(); perfChart.data.datasets.forEach(d=>d.data.shift()) }
  perfChart.update()

  const bands = behaviorToBands({ meanRT: m.avgRT, accuracy: m.acc, rtStd: m.rtStd }, { baselineRT: parseInt(document.getElementById('baselineRT').value||600,10) })
  bandChart.data.labels.push(label)
  const keys=['delta','theta','alpha','beta','gamma']
  keys.forEach((k,i)=> bandChart.data.datasets[i].data.push(bands[k]))
  if(bandChart.data.labels.length>40){ bandChart.data.labels.shift(); bandChart.data.datasets.forEach(d=>d.data.shift()) }
  bandChart.update()
  setBands(bands)
}

/* ===============================
   Session runner: Reaction (drives metrics)
   =============================== */
let running=false, currentTrials=[]
document.getElementById('startSession').addEventListener('click', ()=> startSession(12))
document.getElementById('stopSession').addEventListener('click', ()=> stopSession(true))
document.getElementById('btnPlayBell').addEventListener('click', ()=> document.getElementById('bellAudio').play())
document.getElementById('btnPlayBreath').addEventListener('click', ()=> document.getElementById('breathAudio').play())
document.getElementById('btnShowReport').addEventListener('click', ()=> generateReport())

function log(msg){ const el=document.getElementById('log'); el.innerText = new Date().toLocaleTimeString() + ' ‚Ä¢ ' + msg + '\n' + el.innerText }

async function startSession(trialsCount=12){
  if(running) return
  ensureAudio()
  running=true; currentTrials=[]; document.getElementById('sessionStatus').innerText='Running'
  log('Session started: ' + trialsCount + ' trials')
  const stimEl = document.getElementById('stim')
  for(let i=0;i<trialsCount && running;i++){
    // present stimulus
    const stim = Math.random() < 0.5 ? 'üî¥' : 'üîµ'
    stimEl.innerText = stim; stimEl.style.transform='scale(1.04)'
    const t0 = nowPerf()
    let responded=false
    // wait up to 1800ms for click anywhere
    function clickHandler(){ responded=true; const rt = Math.round(nowPerf() - t0); currentTrials.push({rt,stim,correct:true,t_perf:nowPerf(),t_epoch:tNow()}); window.removeEventListener('click', clickHandler); playClick(880,0.02); log('Response: ' + rt + 'ms') }
    window.addEventListener('click', clickHandler)
    await sleep(1800)
    window.removeEventListener('click', clickHandler)
    if(!responded){ currentTrials.push({rt:null,stim,correct:false,t_perf:nowPerf(),t_epoch:tNow()}); log('Missed') }
    stimEl.style.transform='scale(1)'
    await sleep(220 + Math.random()*240)
  }
  stopSession(false)
}

function stopSession(userStopped=false){
  if(!running && !userStopped) return
  running=false; document.getElementById('sessionStatus').innerText='Idle'
  const session = { id: uid('s'), type:'reaction', trials: currentTrials.slice(), created_at: tNow() }
  saveSession(session)
  const m = computeSessionMetrics(session)
  document.getElementById('lastAvgRT').innerText = m.avgRT?Math.round(m.avgRT):'‚Äî'
  document.getElementById('lastAcc').innerText = m.acc?Math.round(m.acc*100)+'%':'‚Äî'
  // engagement index (transparent): (baselineRT / meanRT) √ó accuracy
  const baseline = parseInt(document.getElementById('baselineRT').value||600,10)
  const engagement = m.avgRT ? ((baseline / m.avgRT) * (m.acc||0)).toFixed(3) : '‚Äî'
  document.getElementById('lastEng').innerText = engagement
  document.getElementById('numSessions').innerText = loadSessions().length
  log('Session ended ‚Äî saved: ' + session.id)
  pushToCharts(session)
}

/* ===============================
   Memory Match Implementation
   =============================== */
let memState={board:[],open:[],matches:0,moves:0,startedAt:0}
document.getElementById('memStart').addEventListener('click', ()=> startMemory(8))
document.getElementById('memShuffle').addEventListener('click', ()=> shuffleMemory())

function startMemory(pairs=8){
  const icons = ['üçé','üçä','üçá','üçâ','üçì','üçí','üçç','ü•ù','üçã','üçë','ü•ë','üçå','ü••','üçê','üçà','ü•≠']
  const pool = icons.slice(0,pairs)
  const deck = shuffle([...pool,...pool])
  memState.board = deck.map((v,i)=>({id:uid('c'), val:v, revealed:false, matched:false}))
  memState.open=[]; memState.matches=0; memState.moves=0; memState.startedAt=tNow()
  renderMemoryBoard()
  log('Memory board started: ' + pairs + ' pairs')
}

function renderMemoryBoard(){
  const board = document.getElementById('memBoard'); board.innerHTML=''
  memState.board.forEach((card, idx)=>{
    const el = document.createElement('div'); el.className='card-face'
    el.innerText = card.revealed || card.matched ? card.val : '‚ùî'
    el.style.opacity = card.matched ? 0.5 : 1
    el.onclick = ()=> onMemClick(idx)
    board.appendChild(el)
  })
  document.getElementById('memMoves').innerText = memState.moves
  document.getElementById('memMatches').innerText = memState.matches
}

function onMemClick(idx){
  const card = memState.board[idx]
  if(card.matched || memState.open.includes(idx) || memState.open.length>=2) return
  memState.board[idx].revealed = true; memState.open.push(idx); renderMemoryBoard()
  if(memState.open.length===2){
    memState.moves++
    const [a,b]=memState.open
    if(memState.board[a].val === memState.board[b].val){
      memState.board[a].matched = memState.board[b].matched = true
      memState.matches++
      playChime(); log('Matched: ' + memState.board[a].val)
    } else {
      playClick(320,0.02); log('Mismatch')
      setTimeout(()=>{ memState.board[a].revealed = memState.board[b].revealed = false; renderMemoryBoard() }, 700)
    }
    memState.open = []
    renderMemoryBoard()
  }
}

function shuffleMemory(){ if(!memState.board.length) return; memState.board = shuffle(memState.board); memState.open=[]; memState.moves=0; memState.matches=0; renderMemoryBoard(); log('Shuffled memory') }

/* Sequence recall */
document.getElementById('seqStart').addEventListener('click', ()=> startSequence(5))
let seqState={sequence:[],userInput:[]}
function startSequence(len=5){
  const pool = ['A','B','C','D','E','F','G','H','I','J','K']
  seqState.sequence = []
  for(let i=0;i<len;i++) seqState.sequence.push(pool[Math.floor(Math.random()*pool.length)])
  const disp = document.getElementById('seqDisplay'); disp.innerHTML = ''
  seqState.sequence.forEach(s => { const el=document.createElement('div'); el.className='card-face'; el.style.background='#eef6ff'; el.style.color='#022'; el.innerText = s; disp.appendChild(el) })
  setTimeout(()=>{ disp.innerHTML = ''; // now user reproduces
    seqState.userInput = [] // simple UX: click elements in a prompt shown as options
    const opts = document.createElement('div'); opts.className='cards-grid'
    const poolSet = Array.from(new Set([...seqState.sequence, ...Array.from({length:6},()=>String.fromCharCode(65+Math.floor(Math.random()*10)))]))
    poolSet.forEach(ch => { const but=document.createElement('div'); but.className='card-face'; but.innerText=ch; but.onclick=()=> { seqState.userInput.push(ch); but.style.opacity=0.5 }; opts.appendChild(but) })
    document.getElementById('seqDisplay').appendChild(opts)
  }, 1500)
}
document.getElementById('seqSubmit').addEventListener('click', ()=> {
  const ok = JSON.stringify(seqState.userInput) === JSON.stringify(seqState.sequence)
  if(ok) { playChime(); log('Sequence correct') } else { playClick(320,0.02); log('Sequence wrong') }
})

/* ===============================
   Visual-Spatial Drag & Drop
   =============================== */
document.getElementById('spatialStart').addEventListener('click', ()=> initSpatial())
let spatialState={targets:[],shapes:[],placed:0}
function initSpatial(){
  spatialState.targets=[]; spatialState.shapes=[]
  const colors=['#FFB703','#FB8500','#219EBC','#8ECAE6','#023047','#FF006E']
  const shapes=['‚ñ¢','‚ñ≤','‚óè','‚óÜ','‚òÖ','‚¨ü']
  // pick 3 targets
  for(let i=0;i<3;i++){
    spatialState.targets.push({id:uid('t'), color:colors[i], shape:shapes[i], filled:false})
    spatialState.shapes.push({id:uid('s'), color:colors[i], shape:shapes[i], placed:false})
  }
  renderSpatial()
}
function renderSpatial(){
  const shapesEl = document.getElementById('shapes'); shapesEl.innerHTML=''
  spatialState.shapes.forEach(s => {
    const el = document.createElement('div'); el.className='shape'; el.draggable=true
    el.style.background = s.color; el.innerText = s.shape; el.id = s.id
    el.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', s.id))
    shapesEl.appendChild(el)
  })
  const targetRow = document.getElementById('targetRow'); targetRow.innerHTML=''
  spatialState.targets.forEach(t => {
    const tr = document.createElement('div'); tr.className='target'; tr.id = t.id; tr.innerText = t.shape
    tr.addEventListener('dragover', e=> e.preventDefault())
    tr.addEventListener('drop', e=>{
      e.preventDefault()
      const sid = e.dataTransfer.getData('text/plain')
      const shapeObj = spatialState.shapes.find(x=>x.id===sid)
      if(!shapeObj) return
      // match by shape char
      if(shapeObj.shape === t.shape){
        // success
        document.getElementById(sid).remove()
        tr.style.background = shapeObj.color; tr.innerText = '‚úì'; shapeObj.placed=true; t.filled=true; spatialState.placed++
        playChime(); log('Placed correctly: ' + shapeObj.shape)
      } else {
        playClick(320,0.02); log('Wrong placement')
      }
      updateSpatialMetrics()
    })
    targetRow.appendChild(tr)
  })
  updateSpatialMetrics()
}
function updateSpatialMetrics(){
  document.getElementById('placedCount').innerText = spatialState.placed
  const total = spatialState.targets.length
  const acc = total ? Math.round((spatialState.placed/total)*100) : 0
  document.getElementById('spatialAcc').innerText = acc + '%'
}

/* ===============================
   Utility functions
   =============================== */
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)) }
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

/* ===============================
   Actions Grid: 100 Buttons (all functional)
   Each button plays a role: play tone, show tip, toggle theme, export, import, add user demo session, etc.
   =============================== */
const actionsGrid = document.getElementById('actionsGrid')
const actionFunctions = []
for(let i=1;i<=100;i++){
  const btn = document.createElement('button'); btn.className='micro-btn'; btn.innerText = 'Action ' + i
  // assign a behavior
  const fn = makeActionFunction(i)
  btn.onclick = ()=> fn()
  actionsGrid.appendChild(btn)
}

function makeActionFunction(n){
  // create variety deterministically
  if(n % 10 === 0) return ()=>{ document.getElementById('medVideo').play(); log('Action '+n+': Played meditation video (CC0)') }
  if(n % 9 === 0) return ()=>{ playChime(); log('Action '+n+': Play chime') }
  if(n % 7 === 0) return ()=>{ playClick(440 + n, 0.02); log('Action '+n+': Play click tone') }
  if(n % 6 === 0) return ()=>{ startSequence(4); log('Action '+n+': Started 4-item sequence') }
  if(n % 5 === 0) return ()=>{ startMemory(4); log('Action '+n+': Started small memory game') }
  if(n % 4 === 0) return ()=>{ initSpatial(); log('Action '+n+': Init spatial puzzle') }
  if(n % 3 === 0) return ()=>{ // toggle theme
    const t = document.getElementById('themeSelect'), val = t.value
    const vals = ['calm','forest','sunset','dark']
    const next = vals[(vals.indexOf(val)+1)%vals.length]; t.value = next; applyTheme(next); log('Action '+n+': Theme -> ' + next)
  }
  if(n % 2 === 0) return ()=>{ // Add a user-initiated "demo" session (explicit, not hidden fake)
    const demo = createDemoSession()
    saveSession(demo); log('Action '+n+': Added demo session (user-initiated): ' + demo.id)
  }
  // else: show a tip
  return ()=>{ log('Action '+n+': Tip ‚Äî Take a 30s breath'); document.getElementById('breathAudio').play() }
}

function createDemoSession(){
  // ONLY create demo when user clicks ‚Äî explicit and visible in log; still real events (simulated by user request)
  const trials = []
  for(let i=0;i<12;i++){
    const rt = 250 + Math.round(Math.random()*500)
    const correct = Math.random()>0.12
    trials.push({rt,choice:correct?'tap':'miss',stim:Math.random()<0.5?'üî¥':'üîµ',correct,t_perf:nowPerf(),t_epoch:tNow()})
  }
  return { id: uid('demo'), type:'reaction-demo', trials, created_at: tNow() }
}

/* ===============================
   Export & Import
   =============================== */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const data = loadSessions(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'})
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'neuro_sessions.json'; a.click()
})
document.getElementById('btnCSV').addEventListener('click', ()=>{
  const arr = loadSessions()
  let rows=[['session_id','type','created_at','idx','rt','correct','stim']]
  arr.forEach(s=>{
    (s.trials||[]).forEach((t,i)=> rows.push([s.id,s.type,new Date(s.created_at).toISOString(),i,(t.rt||''),(t.correct||''),(t.stim||'')]))
  })
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='neuro_sessions.csv'; a.click()
})
document.getElementById('btnImport').addEventListener('click', ()=> {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json'
  inp.onchange = e=> {
    const f = e.target.files[0]; if(!f) return
    const r = new FileReader(); r.onload = ev => {
      try{
        const parsed = JSON.parse(ev.target.result)
        if(Array.isArray(parsed)) { parsed.forEach(s=> saveSession(s)); alert('Imported ' + parsed.length + ' sessions') }
        else alert('JSON must be an array of sessions')
      }catch(err){ alert('Import failed: ' + err.message) }
    }; r.readAsText(f)
  }
  inp.click()
})

/* ===============================
   Profile & Leveling
   =============================== */
document.getElementById('btnCreateProfile').addEventListener('click', ()=>{
  const name = document.getElementById('profileName').value.trim() || 'You'
  let p = loadProfile(); if(!p){ p = createProfile(name) } else { p.name = name; saveProfile(p) }
  alert('Profile selected: ' + p.name)
})
function loadProfile(){ try{ return JSON.parse(localStorage.getItem(P_KEY) || 'null') }catch(e){ return null } }
function saveProfile(p){ localStorage.setItem(P_KEY, JSON.stringify(p)); refreshProfileUI() }
function createProfile(name='You'){ const p={id:uid('u'),name,level:1,xp:0,xpToNext:100,streak:0,createdAt:tNow()}; saveProfile(p); return p }
function refreshProfileUI(){ const p = loadProfile(); if(!p){ document.getElementById('userLevel').innerText='‚Äî'; document.getElementById('userXP').innerText='‚Äî'; return } document.getElementById('userLevel').innerText=p.level; document.getElementById('userXP').innerText=p.xp + ' / ' + (p.xpToNext||100) }

function awardXP(xp){
  let p = loadProfile(); if(!p) p = createProfile(document.getElementById('profileName').value || 'You')
  p.xp = (p.xp||0) + xp
  while(p.xp >= (p.xpToNext||100)){
    p.xp -= (p.xpToNext||100); p.level = (p.level||1) + 1; p.xpToNext = Math.round((p.xpToNext||100) * 1.4)
    log('Level up! New level: ' + p.level)
    playChime()
  }
  saveProfile(p)
}

/* ===============================
   Reports: truthful, shows raw events + formulas
   =============================== */
function generateReport(){
  const sessions = loadSessions()
  if(!sessions.length) return alert('No sessions yet')
  const last = sessions[0]
  const metrics = computeSessionMetrics(last)
  const bands = behaviorToBands({ meanRT:metrics.avgRT, accuracy:metrics.acc, rtStd:metrics.rtStd }, { baselineRT: parseInt(document.getElementById('baselineRT').value||600,10) })
  const report = {
    generatedAt: new Date().toISOString(),
    sessionId: last.id,
    sessionType: last.type,
    metrics,
    bands,
    formulaNote: 'Bands are behavior-derived estimates computed from meanRT, accuracy, and RT variance. See settings for formulas.'
  }
  const win = window.open('', '_blank')
  win.document.write('<pre style="white-space:pre-wrap;">' + JSON.stringify(report, null, 2) + '</pre>')
}

/* ===============================
   UI & Initialization
   =============================== */
function refreshUI(){
  document.getElementById('numSessions').innerText = loadSessions().length
  const rec = document.getElementById('recentList'); rec.innerHTML = ''
  loadSessions().slice(0,6).forEach(s=>{ const d = document.createElement('div'); d.className='tiny muted'; d.innerHTML = `<strong>${s.type}</strong> ‚Ä¢ ${new Date(s.created_at).toLocaleString()}`; rec.appendChild(d) })
  refreshProfileUI()
}
refreshUI()

// tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'))
    t.classList.add('active')
    const tab = t.getAttribute('data-tab')
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'))
    document.getElementById('panel-' + tab).classList.add('active')
  })
})

/* ===============================
   Helpers used by multiple parts
   =============================== */
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)() }

/* initialize: populate actionsGrid already done, refresh UI */
refreshUI()

</script>
</body>
</html>
